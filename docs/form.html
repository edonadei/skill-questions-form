<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Form</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --hint: var(--tg-theme-hint-color, #999999);
    --link: var(--tg-theme-link-color, #2678b6);
    --btn: var(--tg-theme-button-color, #2678b6);
    --btn-text: var(--tg-theme-button-text-color, #ffffff);
    --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 16px;
    padding-bottom: 100px;
    -webkit-text-size-adjust: 100%;
  }

  .form-title {
    font-size: 15px;
    color: var(--hint);
    margin-bottom: 20px;
    text-align: center;
  }

  .question {
    margin-bottom: 24px;
  }

  .question-label {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
    line-height: 1.3;
  }

  .question-number {
    color: var(--link);
  }

  .options {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .option {
    display: flex;
    align-items: center;
    padding: 12px 14px;
    border-radius: 12px;
    background: var(--secondary-bg);
    cursor: pointer;
    transition: all 0.15s ease;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  .option:active {
    transform: scale(0.98);
  }

  .option.selected {
    background: var(--btn);
    color: var(--btn-text);
  }

  .radio {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--hint);
    margin-right: 12px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
  }

  .option.selected .radio {
    border-color: var(--btn-text);
  }

  .radio-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: transparent;
    transition: all 0.15s ease;
  }

  .option.selected .radio-dot {
    background: var(--btn-text);
  }

  .option-text {
    font-size: 15px;
    flex: 1;
  }

  .other-input-wrapper {
    margin-top: 6px;
  }

  .other-input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 2px solid var(--secondary-bg);
    background: var(--secondary-bg);
    color: var(--text);
    font-size: 15px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.15s ease;
  }

  .other-input:focus {
    border-color: var(--btn);
  }

  .other-input::placeholder {
    color: var(--hint);
  }

  .other-input.active {
    border-color: var(--btn);
    background: var(--bg);
  }

  .error-msg {
    color: #e53935;
    font-size: 13px;
    margin-top: 16px;
    text-align: center;
    display: none;
  }

  .error-msg.visible {
    display: block;
  }
</style>
</head>
<body>

<div class="form-title">Answer all questions, then tap Submit</div>
<div id="form-container"></div>
<div id="error-msg" class="error-msg">Please answer all questions before submitting.</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Parse form config from URL hash (base64-encoded JSON)
let config;
try {
  const hash = window.location.hash.substring(1);
  const json = decodeURIComponent(atob(hash));
  config = JSON.parse(json);
} catch (e) {
  document.getElementById('form-container').innerHTML =
    '<p style="text-align:center;color:var(--hint)">Invalid form configuration.</p>';
  throw new Error('Failed to parse form config: ' + e.message);
}

// State: { questionId: selectedValue }
const state = {};
const container = document.getElementById('form-container');
const errorMsg = document.getElementById('error-msg');

// Render questions
config.questions.forEach((q, idx) => {
  const questionDiv = document.createElement('div');
  questionDiv.className = 'question';
  questionDiv.dataset.id = q.id;

  const label = document.createElement('div');
  label.className = 'question-label';
  label.innerHTML = `<span class="question-number">${idx + 1}.</span> ${escapeHtml(q.text)}`;
  questionDiv.appendChild(label);

  const optionsDiv = document.createElement('div');
  optionsDiv.className = 'options';

  // Render each option
  q.options.forEach(opt => {
    const optionEl = document.createElement('div');
    optionEl.className = 'option';
    optionEl.innerHTML = `
      <div class="radio"><div class="radio-dot"></div></div>
      <span class="option-text">${escapeHtml(opt.label)}</span>
    `;
    optionEl.addEventListener('click', () => {
      selectOption(q.id, opt.value, questionDiv);
    });
    optionsDiv.appendChild(optionEl);
  });

  questionDiv.appendChild(optionsDiv);

  // "Other" input if enabled (default: true)
  if (q.allowOther !== false) {
    const otherWrapper = document.createElement('div');
    otherWrapper.className = 'other-input-wrapper';
    const otherInput = document.createElement('input');
    otherInput.type = 'text';
    otherInput.className = 'other-input';
    otherInput.placeholder = 'Other â€” type your answer';
    otherInput.dataset.qid = q.id;

    otherInput.addEventListener('focus', () => {
      // Deselect any button option for this question
      clearOptionSelection(questionDiv);
      otherInput.classList.add('active');
      state[q.id] = '';
    });

    otherInput.addEventListener('input', () => {
      state[q.id] = otherInput.value.trim() || null;
      errorMsg.classList.remove('visible');
    });

    otherWrapper.appendChild(otherInput);
    questionDiv.appendChild(otherWrapper);
  }

  container.appendChild(questionDiv);
});

function selectOption(qid, value, questionDiv) {
  state[qid] = value;
  errorMsg.classList.remove('visible');

  // Update visual selection
  const options = questionDiv.querySelectorAll('.option');
  options.forEach(opt => opt.classList.remove('selected'));
  event.currentTarget.classList.add('selected');

  // Clear "Other" input if present
  const otherInput = questionDiv.querySelector('.other-input');
  if (otherInput) {
    otherInput.value = '';
    otherInput.classList.remove('active');
    otherInput.blur();
  }
}

function clearOptionSelection(questionDiv) {
  questionDiv.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Main Button (Submit)
tg.MainButton.setText('Submit All Answers');
tg.MainButton.show();

tg.MainButton.onClick(() => {
  // Validate all questions answered
  const unanswered = config.questions.filter(q => !state[q.id]);

  if (unanswered.length > 0) {
    errorMsg.classList.add('visible');
    // Scroll to first unanswered
    const firstUnanswered = document.querySelector(`[data-id="${unanswered[0].id}"]`);
    if (firstUnanswered) {
      firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    return;
  }

  // Build result with human-readable labels
  const result = {};
  config.questions.forEach(q => {
    const selectedValue = state[q.id];
    const matchedOption = q.options.find(o => o.value === selectedValue);
    result[q.id] = {
      question: q.text,
      value: selectedValue,
      label: matchedOption ? matchedOption.label : selectedValue
    };
  });

  tg.sendData(JSON.stringify(result));
});
</script>
</body>
</html>
